# Session: 2026-01-30 Performance Optimization

## Context
Identified and eliminated duplicate database queries caused by Search component pre-fetching all posts in the header. This was causing 14+ queries per page load, significantly impacting performance.

## Work Summary
- Converted Search component to lazy loading - fetches posts via API only when modal opens
- Removed getAllPosts() call from header component that was pre-fetching data unnecessarily
- Updated API route to include category data for search functionality
- Applied React cache() wrapper to posts.ts, categories.ts, and settings.ts for request deduplication
- Reduced database queries from 14+ to approximately 8 per page load

## Problems & Solutions
- **Problem**: Search component was pre-fetching all posts during initial header render → Solution: Made search lazy-load via API on modal open
- **Problem**: Multiple identical database queries on same page load → Solution: Added React cache() wrapper to utility functions for request deduplication

## Decisions
1. **Search as client-side lazy-load**: Moved from server-side pre-fetch to client-side on-demand API fetch. Rationale: Better performance, only fetch when user actually opens search modal
2. **API-driven search**: Instead of passing pre-fetched data through props, Search now calls `/api/posts` endpoint. Rationale: Cleaner separation of concerns, supports future filtering/pagination
3. **React cache() for deduplication**: Added cache wrapper to shared utility functions. Rationale: Prevents multiple identical queries during same request lifecycle

## Incomplete/TODO
- [ ] Verify query reduction with performance monitoring/DevTools
- [ ] Consider adding search-specific API endpoint for pagination/filtering if needed
- [ ] Test Search component behavior on slow network conditions
- [ ] Monitor for any edge cases with lazy-loaded search data

## Files Modified
- `/app/api/posts/route.ts` - Added category include for search
- `/components/header.tsx` - Removed getAllPosts pre-fetch
- `/components/search.tsx` - Implemented lazy API fetch on modal open
- `/lib/categories.ts` - Added React cache()
- `/lib/posts.ts` - Added React cache()
- `/lib/settings.ts` - Added React cache()

## Next Session Suggestions
1. Profile actual query performance improvements with DevTools/logging
2. Consider search-specific optimizations (debouncing, partial results)
3. Evaluate other components for similar pre-fetch anti-patterns
4. Monitor production performance metrics for this change

---

**Last Updated**: 2026-01-30
